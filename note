import React, { useState } from 'react';
import { Upload, Info, LogOut, User, Lock, Eye, EyeOff, Mail, UserPlus } from 'lucide-react';

const BreastCancerApp = () => {
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  const [isSignUp, setIsSignUp] = useState(false);
  const [loginForm, setLoginForm] = useState({ username: '', password: '' });
  const [signUpForm, setSignUpForm] = useState({ 
    username: '', 
    email: '', 
    password: '', 
    confirmPassword: '' 
  });
  const [uploadedImage, setUploadedImage] = useState(null);
  const [results, setResults] = useState(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [showTutorial, setShowTutorial] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');

  // Simulated user database (in real app, this would be in a backend)
  const [users, setUsers] = useState([
    { username: 'demo', email: 'demo@example.com', password: 'demo123' }
  ]);

  const handleLogin = () => {
    setError('');
    
    const user = users.find(
      u => u.username === loginForm.username && u.password === loginForm.password
    );
    
    if (user) {
      setIsLoggedIn(true);
      setShowTutorial(true);
      setLoginForm({ username: '', password: '' });
    } else {
      setError('Invalid username or password');
    }
  };

  const handleSignUp = () => {
    setError('');
    setSuccess('');

    // Validation
    if (!signUpForm.username || !signUpForm.email || !signUpForm.password || !signUpForm.confirmPassword) {
      setError('All fields are required');
      return;
    }

    if (signUpForm.password !== signUpForm.confirmPassword) {
      setError('Passwords do not match');
      return;
    }

    if (signUpForm.password.length < 6) {
      setError('Password must be at least 6 characters');
      return;
    }

    if (users.find(u => u.username === signUpForm.username)) {
      setError('Username already exists');
      return;
    }

    if (users.find(u => u.email === signUpForm.email)) {
      setError('Email already registered');
      return;
    }

    // Add new user
    setUsers([...users, {
      username: signUpForm.username,
      email: signUpForm.email,
      password: signUpForm.password
    }]);

    setSuccess('Account created successfully! Please login.');
    setSignUpForm({ username: '', email: '', password: '', confirmPassword: '' });
    
    // Switch to login after 2 seconds
    setTimeout(() => {
      setIsSignUp(false);
      setSuccess('');
    }, 2000);
  };

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (event) => {
        setUploadedImage(event.target.result);
        setResults(null);
      };
      reader.readAsDataURL(file);
    }
  };

  // THIS IS WHERE YOU'LL INTEGRATE YOUR MODEL
  const analyzeImageWithModel = async () => {
    if (!uploadedImage) return;
    
    setIsAnalyzing(true);
    setError('');

    try {
      // OPTION 1: If your model is deployed as an API
      // Uncomment and modify this section:
      /*
      const response = await fetch('YOUR_MODEL_API_URL', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          image: uploadedImage.split(',')[1] // Send base64 without data:image prefix
        })
      });

      if (!response.ok) {
        throw new Error('Model API request failed');
      }

      const data = await response.json();
      
      // Format the response to match your model's output
      setResults({
        prediction: data.prediction, // e.g., 'Malignant' or 'Benign'
        confidence: data.confidence, // e.g., 95.5
        heatmap: data.heatmap_url || uploadedImage, // URL to heatmap image
        details: data.details || {} // Additional detection details
      });
      */

      // OPTION 2: Using TensorFlow.js to load your model directly
      // You'll need to convert your model to TensorFlow.js format first
      /*
      // Load model (do this once, maybe in useEffect)
      const model = await tf.loadLayersModel('path/to/your/model.json');
      
      // Preprocess image
      const img = new Image();
      img.src = uploadedImage;
      await img.decode();
      
      const tensor = tf.browser.fromPixels(img)
        .resizeNearestNeighbor([224, 224]) // Adjust size to your model's input
        .toFloat()
        .div(255.0)
        .expandDims();
      
      // Make prediction
      const prediction = await model.predict(tensor);
      const results = await prediction.data();
      
      // Format results
      setResults({
        prediction: results[0] > 0.5 ? 'Malignant' : 'Benign',
        confidence: (results[0] * 100).toFixed(2),
        heatmap: uploadedImage,
        details: {}
      });
      */

      // TEMPORARY: Mock results for demonstration
      // Remove this when you integrate your real model
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      const mockResults = {
        prediction: Math.random() > 0.5 ? 'Malignant' : 'Benign',
        confidence: (Math.random() * 30 + 70).toFixed(2),
        heatmap: uploadedImage,
        details: {
          'Mass Detected': Math.random() > 0.3,
          'Calcification': Math.random() > 0.6,
          'Asymmetry': Math.random() > 0.5
        }
      };
      setResults(mockResults);

    } catch (err) {
      console.error('Analysis error:', err);
      setError('Failed to analyze image. Please try again.');
    } finally {
      setIsAnalyzing(false);
    }
  };

  const handleLogout = () => {
    setIsLoggedIn(false);
    setUploadedImage(null);
    setResults(null);
    setLoginForm({ username: '', password: '' });
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter') {
      if (isSignUp) {
        handleSignUp();
      } else {
        handleLogin();
      }
    }
  };

  // Login/Sign Up Page
  if (!isLoggedIn) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
          <div className="text-center mb-8">
            <div className="inline-block p-3 bg-indigo-100 rounded-full mb-4">
              <svg className="w-12 h-12 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
              </svg>
            </div>
            <h1 className="text-3xl font-bold text-gray-800 mb-2">Breast Cancer Detection</h1>
            <p className="text-gray-600">AI-Powered Medical Imaging Analysis</p>
          </div>

          {/* Toggle between Login and Sign Up */}
          <div className="flex mb-6 bg-gray-100 rounded-lg p-1">
            <button
              onClick={() => {
                setIsSignUp(false);
                setError('');
                setSuccess('');
              }}
              className={`flex-1 py-2 rounded-md transition-colors ${!isSignUp ? 'bg-white text-indigo-600 shadow' : 'text-gray-600'}`}
            >
              Login
            </button>
            <button
              onClick={() => {
                setIsSignUp(true);
                setError('');
                setSuccess('');
              }}
              className={`flex-1 py-2 rounded-md transition-colors ${isSignUp ? 'bg-white text-indigo-600 shadow' : 'text-gray-600'}`}
            >
              Sign Up
            </button>
          </div>

          {/* Login Form */}
          {!isSignUp && (
            <div className="space-y-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Username</label>
                <div className="relative">
                  <User className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                  <input
                    type="text"
                    value={loginForm.username}
                    onChange={(e) => setLoginForm({...loginForm, username: e.target.value})}
                    onKeyPress={handleKeyPress}
                    className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    placeholder="Enter username"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                <div className="relative">
                  <Lock className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                  <input
                    type={showPassword ? "text" : "password"}
                    value={loginForm.password}
                    onChange={(e) => setLoginForm({...loginForm, password: e.target.value})}
                    onKeyPress={handleKeyPress}
                    className="w-full pl-10 pr-12 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    placeholder="Enter password"
                  />
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                  >
                    {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                  </button>
                </div>
              </div>

              {error && (
                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                  {error}
                </div>
              )}

              <button
                onClick={handleLogin}
                className="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-semibold"
              >
                Login
              </button>

              <div className="p-4 bg-blue-50 rounded-lg">
                <p className="text-sm text-gray-600 text-center">
                  <strong>Demo Account:</strong><br />
                  Username: demo | Password: demo123
                </p>
              </div>
            </div>
          )}

          {/* Sign Up Form */}
          {isSignUp && (
            <div className="space-y-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Username</label>
                <div className="relative">
                  <User className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                  <input
                    type="text"
                    value={signUpForm.username}
                    onChange={(e) => setSignUpForm({...signUpForm, username: e.target.value})}
                    onKeyPress={handleKeyPress}
                    className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    placeholder="Choose a username"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <div className="relative">
                  <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                  <input
                    type="email"
                    value={signUpForm.email}
                    onChange={(e) => setSignUpForm({...signUpForm, email: e.target.value})}
                    onKeyPress={handleKeyPress}
                    className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    placeholder="Enter your email"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                <div className="relative">
                  <Lock className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                  <input
                    type={showPassword ? "text" : "password"}
                    value={signUpForm.password}
                    onChange={(e) => setSignUpForm({...signUpForm, password: e.target.value})}
                    onKeyPress={handleKeyPress}
                    className="w-full pl-10 pr-12 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    placeholder="Create a password"
                  />
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                  >
                    {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                  </button>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
                <div className="relative">
                  <Lock className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                  <input
                    type={showConfirmPassword ? "text" : "password"}
                    value={signUpForm.confirmPassword}
                    onChange={(e) => setSignUpForm({...signUpForm, confirmPassword: e.target.value})}
                    onKeyPress={handleKeyPress}
                    className="w-full pl-10 pr-12 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    placeholder="Confirm your password"
                  />
                  <button
                    type="button"
                    onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                    className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                  >
                    {showConfirmPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                  </button>
                </div>
              </div>

              {error && (
                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                  {error}
                </div>
              )}

              {success && (
                <div className="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg text-sm">
                  {success}
                </div>
              )}

              <button
                onClick={handleSignUp}
                className="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-semibold flex items-center justify-center space-x-2"
              >
                <UserPlus className="w-5 h-5" />
                <span>Create Account</span>
              </button>
            </div>
          )}
        </div>
      </div>
    );
  }

  // Main Application Page (same as before)
  return (
    <div className="min-h-screen bg-gray-50">
      {/* Tutorial Modal */}
      {showTutorial && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-800">How to Use</h2>
              <button
                onClick={() => setShowTutorial(false)}
                className="text-gray-500 hover:text-gray-700"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            <div className="space-y-6">
              <div className="flex items-start space-x-4">
                <div className="flex-shrink-0 w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">1</div>
                <div>
                  <h3 className="font-semibold text-gray-800 mb-1">Upload Medical Image</h3>
                  <p className="text-gray-600">Click the upload area and select a mammogram or breast imaging file (JPEG, PNG).</p>
                </div>
              </div>

              <div className="flex items-start space-x-4">
                <div className="flex-shrink-0 w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">2</div>
                <div>
                  <h3 className="font-semibold text-gray-800 mb-1">Analyze Image</h3>
                  <p className="text-gray-600">Click the "Analyze Image" button to process the image using the AI model.</p>
                </div>
              </div>

              <div className="flex items-start space-x-4">
                <div className="flex-shrink-0 w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold">3</div>
                <div>
                  <h3 className="font-semibold text-gray-800 mb-1">Review Results</h3>
                  <p className="text-gray-600">View the prediction, confidence level, and heatmap showing areas of interest detected by the AI.</p>
                </div>
              </div>

              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p className="text-sm text-yellow-800">
                  <strong>Important:</strong> This tool is for educational purposes. Always consult with qualified medical professionals for diagnosis and treatment decisions.
                </p>
              </div>
            </div>

            <button
              onClick={() => setShowTutorial(false)}
              className="w-full mt-6 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-semibold"
            >
              Got it!
            </button>
          </div>
        </div>
      )}

      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
          <h1 className="text-2xl font-bold text-indigo-600">Breast Cancer Detection</h1>
          <div className="flex items-center space-x-4">
            <button
              onClick={() => setShowTutorial(true)}
              className="flex items-center space-x-2 text-gray-600 hover:text-indigo-600 transition-colors"
            >
              <Info className="w-5 h-5" />
              <span>Help</span>
            </button>
            <button
              onClick={handleLogout}
              className="flex items-center space-x-2 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors"
            >
              <LogOut className="w-5 h-5" />
              <span>Logout</span>
            </button>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 py-8">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {/* Upload Section */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Upload Image</h2>
            
            <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-indigo-500 transition-colors cursor-pointer">
              <input
                type="file"
                accept="image/*"
                onChange={handleImageUpload}
                className="hidden"
                id="image-upload"
              />
              <label htmlFor="image-upload" className="cursor-pointer">
                {uploadedImage ? (
                  <div>
                    <img src={uploadedImage} alt="Uploaded" className="max-h-64 mx-auto rounded-lg mb-4" />
                    <p className="text-sm text-gray-600">Click to upload a different image</p>
                  </div>
                ) : (
                  <div>
                    <Upload className="w-16 h-16 mx-auto text-gray-400 mb-4" />
                    <p className="text-gray-600 mb-2">Click to upload medical image</p>
                    <p className="text-sm text-gray-400">Supports: JPEG, PNG</p>
                  </div>
                )}
              </label>
            </div>

            {uploadedImage && (
              <button
                onClick={analyzeImageWithModel}
                disabled={isAnalyzing}
                className="w-full mt-6 bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-semibold disabled:bg-gray-400 disabled:cursor-not-allowed"
              >
                {isAnalyzing ? 'Analyzing...' : 'Analyze Image'}
              </button>
            )}
          </div>

          {/* Results Section */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Analysis Results</h2>
            
            {!results && !isAnalyzing && (
              <div className="text-center py-16 text-gray-400">
                <svg className="w-24 h-24 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <p>Upload and analyze an image to see results</p>
              </div>
            )}

            {isAnalyzing && (
              <div className="text-center py-16">
                <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                <p className="text-gray-600">Analyzing image with AI model...</p>
              </div>
            )}

            {results && (
              <div className="space-y-6">
                <div className={`p-4 rounded-lg ${results.prediction === 'Malignant' ? 'bg-red-50 border border-red-200' : 'bg-green-50 border border-green-200'}`}>
                  <div className="flex justify-between items-center">
                    <div>
                      <p className="text-sm text-gray-600 mb-1">Prediction</p>
                      <p className={`text-2xl font-bold ${results.prediction === 'Malignant' ? 'text-red-700' : 'text-green-700'}`}>
                        {results.prediction}
                      </p>
                    </div>
                    <div className="text-right">
                      <p className="text-sm text-gray-600 mb-1">Confidence</p>
                      <p className="text-2xl font-bold text-gray-800">{results.confidence}%</p>
                    </div>
                  </div>
                </div>

                <div>
                  <h3 className="font-semibold text-gray-800 mb-3">Detection Heatmap</h3>
                  <img src={results.heatmap} alt="Heatmap" className="w-full rounded-lg border border-gray-200" />
                  <p className="text-xs text-gray-500 mt-2">Areas highlighted show regions analyzed by the AI model</p>
                </div>

                <div>
                  <h3 className="font-semibold text-gray-800 mb-3">Detailed Analysis</h3>
                  <div className="space-y-2">
                    {Object.entries(results.details).map(([key, value]) => (
                      <div key={key} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span className="text-gray-700">{key}</span>
                        <span className={`font-semibold ${value ? 'text-red-600' : 'text-green-600'}`}>
                          {value ? 'Detected' : 'Not Detected'}
                        </span>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <p className="text-sm text-blue-800">
                    <strong>Disclaimer:</strong> This analysis is provided for educational purposes only. Please consult with a qualified healthcare professional for proper medical diagnosis and treatment.
                  </p>
                </div>
              </div>
            )}
          </div>
        </div>
      </main>
    </div>
  );
};

export default BreastCancerApp;